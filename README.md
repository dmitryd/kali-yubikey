# Yubikey, LUKS and Kali Linux

## About

There are various solutions to use yubikey with LUKS. Most of them (except [one](https://github.com/flowolf/initramfs_ykfde/)) have a certain security risk: though LUKS passphrase is generated by yubikey, it is static. So if anybody can save the key in some way, it can unlock LUKS partition without yubikey.

I came across the [experimental project](https://github.com/flowolf/initramfs_ykfde/) for Gentoo Linux to change LUKS key after each login. But Gentoo Linux is very different from Kali (Kali is based in Debian) and it has completely different way to initialize kernal and unlock encripted drives. I took challenge and implemented similar script for Kali Linux. I did not test it with stock Debian, I guess it should work there too because Kali is based on Debian.

There are several important things you should know:

* **Security note:** Due to the structure of Kali init scripts, key handling had to be split to several scripts. To transfer data, temporary files are created on the `/boot` partition. Two of them contain sensitive information. `/boot/kfo` contains the current LUKS password and `/boot/kfn` contains the new LUKS password. These files are securely erased if the volume is unlocked. However a malicious `initramfs` hook can read these files. Alternatively, if the computer is powered off during boot, these files can remain on the file system and provide an easy way to unlock your computer. Always wait until boot process finishes before powering down the computer!
* LUKS key slot 2 is hard-coded in the script to let you use key slot 1 for the nuke key (which you definitely should use!)
* You should always have a backup passphrase: long and hard to guess. You will be able to enter it each 3<sup>rd</sup> time when you are prompted for the password.

## Setting up

You have to build some packages manually. While Yubico packages exist in Kali repositories, they are not suitable for `initramfs`.

Install packages:

```sh
apt-get install pkg-config
```

Don't use `libusb-1.0.0`, see [here](http://forum.yubico.com/viewtopic.php?f=16&t=858) why.

```sh
apt-get install libusb-dev
apt-get install libyubikey-dev
apt-get install asciidoc
apt-get install dh-autoreconf
mkdir yubico
cd yubico
git clone https://github.com/Yubico/yubico-c.git
cd yubico-c
autoreconf --install
./configure --with-backend=libusb
make LD_FLAGS=-all-static
git clone https://github.com/Yubico/yubikey-personalization.git
autoreconf --install
./configure --with-backend=libusb
make LD_FLAGS=-all-static
make install
```

Remove asciidoc:

```sh
apt-get purge asciidoc dblatex dblatex-doc docbook-dsssl docbook-utils docbook-xml docbook-xsl fonts-texgyre jadetex libfile-homedir-perl libfile-which-perl libosp5 libostyle1c2 libsgmls-perl libxml2-utils libyaml-tiny-perl lynx lynx-common openjade opensp preview-latex-style prosper ps2eps sgml-data sgmlspl tex-gyre texlive texlive-bibtex-extra texlive-extra-utils texlive-font-utils texlive-fonts-recommended texlive-fonts-recommended-doc texlive-generic-recommended texlive-htmlxml texlive-latex-extra texlive-latex-extra-doc texlive-latex-recommended texlive-latex-recommended-doc texlive-luatex texlive-math-extra texlive-pictures texlive-pictures-doc texlive-pstricks texlive-pstricks-doc tipa xmlto xsltproc
```

Remove autoreconf:

```sh
apt-get purge autoconf automake autopoint autotools-dev debhelper dh-autoreconf dh-strip-nondeterminism gettext intltool-debian libarchive-zip-perl libfile-stripnondeterminism-perl libltdl-dev libmail-sendmail-perl libsys-hostname-long-perl libtool po-debconf
```

Copy scripts using `copy_scripts.sh` inside this directory.

Modify `/etc/crypttab`:

```
sda5_crypt UUID=4d435248-dfa8-4f77-8adb-c75242e178a0 none luks,keyscript=yubikey_unlock
```

`sda5_crypt` is the default if you used "full disk encrypted" option during setup. `UUID` will be different in your case.

Connect yubikey and personalize it:

```sh
ykpersonalize -2 -ochal-resp -ochal-hmac -oserial-usb-visible -oserial-api-visible
```

<a href="initial"></a>Create initial challenge and key:

```sh
uuidgen > /boot/yk_challenge
ykchalresp -2 "yourpassword`cat /boot/yk_challenge`" > kf
cryptsetup luksAddKey --key-slot 2 /dev/sda5 kf
shred -u -z kf
```

**Note:** `yourpassword` above is the password you will type each time during login with yubikey. This is **not** your initial (safe) passphrase you entered during installation!

Rebuild `initramfs`:

```sh
update-initramfs -u
```

Reboot with youbikey inserted. If your yubikey password does not work, you can login with safety password when you see `Enter your password to unlock the disk (2):`. Next you should remove the key from the slot:

```sh
cryptsetup luksKillSlot /dev/sda 2
```

Now you can [re-create](#initial) initial challenge and key to try again.

## License

GPL v3 or newer. Remember that attribution is required.

## Support

While I am interested in improvements and suggestions, I cannot provide any support or guarantees. Use at your own risk.
